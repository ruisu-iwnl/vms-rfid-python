{% extends 'dashboard/admin/layout.html' %}

{% block title %}Registered Users | TimeGuard {% endblock %}

{% block header_title %}User List{% endblock %}

{% block content %}

<div class="w-full h-full p-6">
    <div class="mb-4 flex justify-between items-center">
        <!-- Buttons to open modals -->
        <div class="flex space-x-4 mb-4">
            <button id="openUserModalBtn" class="bg-green-500 text-black py-4 px-8 rounded border border-black hover:bg-green-700" style="background-color: #eeeee4; font-size: 1.25rem;">
                <img src="{{ url_for('static', filename='images/icons/adduser.svg') }}" alt="Add User" class="inline h-8 w-8 mr-2"> Add User
            </button>
            {% include 'dashboard/admin/modals/adduser.html' %}
            
            <button id="openModalBtn" class="bg-blue-500 text-black py-4 px-8 rounded border border-black hover:bg-blue-700" style="background-color: #eeeee4; font-size: 1.25rem;">
                <img src="{{ url_for('static', filename='images/icons/addvehicle.svg') }}" alt="Add Vehicle" class="inline h-8 w-8 mr-2"> Add Vehicle
            </button>
            {% include 'dashboard/admin/modals/addvehicle.html' %}
        </div>

        <!-- Search Bar -->
        <div class="relative w-1/3">
            <input type="text" id="search-bar" placeholder="Search users..." class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
        </div>
    </div>
    
<!-- Table Container -->
<div class="bg-[#eeeee4] p-6 rounded-lg shadow-md w-full max-w-full mb-8 relative">
    <table class="min-w-full divide-y divide-gray-300" id="user-table">
        <thead class="bg-[#eeeee4]">
            <tr>
                <th class="px-6 py-3 text-left text-lg font-medium text-black uppercase tracking-wider">
                    <a href="{{ url_for('userlist.userlist', page=page, sort_by='emp_no', order='asc' if sort_by != 'emp_no' or order == 'desc' else 'desc') }}">
                        Employee Number
                        {% if sort_by == 'emp_no' %}
                            {% if order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th class="px-6 py-3 text-left text-lg font-medium text-black uppercase tracking-wider">
                    <a href="{{ url_for('userlist.userlist', page=page, sort_by='full_name', order='asc' if sort_by != 'full_name' or order == 'desc' else 'desc') }}">
                        Full Name
                        {% if sort_by == 'full_name' %}
                            {% if order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th class="px-6 py-3 text-left text-lg font-medium text-black uppercase tracking-wider">
                    <a href="{{ url_for('userlist.userlist', page=page, sort_by='created_at', order='asc' if sort_by != 'created_at' or order == 'desc' else 'desc') }}">
                        Created At
                        {% if sort_by == 'created_at' %}
                            {% if order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th class="px-6 py-3 text-left text-lg font-medium text-black uppercase tracking-wider">
                    <a href="{{ url_for('userlist.userlist', page=page, sort_by='contactnumber', order='asc' if sort_by != 'contactnumber' or order == 'desc' else 'desc') }}">
                        Contact Number
                        {% if sort_by == 'contactnumber' %}
                            {% if order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th class="px-6 py-3 text-left text-lg font-medium text-black uppercase tracking-wider">
                    <a href="{{ url_for('userlist.userlist', page=page, sort_by='vehicle_count', order='asc' if sort_by != 'vehicle_count' or order == 'desc' else 'desc') }}">
                        Vehicle/s
                        {% if sort_by == 'vehicle_count' %}
                            {% if order == 'asc' %}▲{% else %}▼{% endif %}
                        {% endif %}
                    </a>
                </th>                    
                <th class="px-6 py-3 text-left text-lg font-medium text-black uppercase tracking-wider">License Plate</th>
            </tr>
        </thead>
        
        <tbody class="bg-[#eeeee4] divide-y divide-gray-300" id="user-table-body">
            {% for user in users %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-lg font-medium text-black">{{ user[0] }}</td> <!-- emp_no -->
                    <td class="px-6 py-4 whitespace-nowrap text-lg text-black flex items-center">
                        {% if user[7] %}
                            <img src="{{ url_for('static', filename='images/users/' + user[7]) }}" alt="Profile Image" class="w-[50px] h-[50px] rounded-full mr-4">
                        {% else %}
                            <img src="{{ url_for('static', filename='images/users/profile.svg') }}" alt="Default Profile Image" class="w-[50px] h-[50px] rounded-full mr-4">
                        {% endif %}
                        {{ user[1] }} <!-- full_name -->
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-lg text-black">{{ user[6] }}</td> <!-- created_at -->
                    <td class="px-6 py-4 whitespace-nowrap text-lg text-black">{{ user[2] }}</td> <!-- contactnumber -->
                    <td class="px-6 py-4 whitespace-nowrap text-lg text-black">
                        {% if user[3] %}
                            {% if ',' in user[3] %}
                                <div class="relative">
                                    <button class="bg-gray-200 text-gray-700 py-1 px-2 rounded hover:bg-gray-300 focus:outline-none toggle-dropdown" data-dropdown-id="dropdown-{{ loop.index }}">
                                        View Vehicles
                                    </button>
                                    <div id="dropdown-{{ loop.index }}" class="absolute mt-2 py-2 w-48 bg-white rounded-lg shadow-xl z-10 hidden">
                                        {% for vehicle in user[3].split(', ') %}
                                            <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">{{ vehicle }}</a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                {{ user[3] }}
                            {% endif %}
                        {% else %}
                            No Vehicle Registered
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-lg text-black">
                        {% if user[4] %}
                            {% if ',' in user[4] %}
                                <div class="relative">
                                    <button class="bg-gray-200 text-gray-700 py-1 px-2 rounded hover:bg-gray-300 focus:outline-none toggle-dropdown" data-dropdown-id="plate-dropdown-{{ loop.index }}">
                                        View Plates
                                    </button>
                                    <div id="plate-dropdown-{{ loop.index }}" class="absolute mt-2 py-2 w-48 bg-white rounded-lg shadow-xl z-10 hidden">
                                        {% for plate in user[4].split(', ') %}
                                            <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">{{ plate }}</a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                {{ user[4] }}
                            {% endif %}
                        {% else %}
                            No Plate Available
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
        
    </table>
    <!-- Pagination -->
    <div class="flex justify-center mt-4">
        <nav class="relative z-0 inline-flex shadow-sm -space-x-px" aria-label="Pagination">
            {% if page > 1 %}
                <a href="{{ url_for('userlist.userlist', page=page-1, sort_by=sort_by, order=order) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-lg font-medium text-black bg-white hover:bg-gray-50">
                    Previous
                </a>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
                <a href="{{ url_for('userlist.userlist', page=p, sort_by=sort_by, order=order) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-lg font-medium {{ 'bg-gray-200' if p == page else 'bg-white' }} hover:bg-gray-50">
                    {{ p }}
                </a>
            {% endfor %}
            {% if page < total_pages %}
                <a href="{{ url_for('userlist.userlist', page=page+1, sort_by=sort_by, order=order) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-lg font-medium text-black bg-white hover:bg-gray-50">
                    Next
                </a>
            {% endif %}
        </nav>
    </div>
</div>


</div>

<script>

    // Open and close User Modal
    document.getElementById('openUserModalBtn').addEventListener('click', function() {
            const modal = document.getElementById('userModal');
            modal.classList.remove('hidden');
            // Trigger the transition
            setTimeout(() => modal.classList.add('show'), 10);
        });

        document.getElementById('closeUserModalBtn').addEventListener('click', function() {
            const modal = document.getElementById('userModal');
            modal.classList.remove('show');
            setTimeout(() => modal.classList.add('hidden'), 300); 
        });

    document.getElementById('openModalBtn').addEventListener('click', function() {
            const modal = document.getElementById('vehicleModal');
            modal.classList.remove('hidden');
            // Trigger the transition
            setTimeout(() => modal.classList.add('show'), 10);
        });

        document.getElementById('closeModalBtn').addEventListener('click', function() {
            const modal = document.getElementById('vehicleModal');
            modal.classList.remove('show');
            setTimeout(() => modal.classList.add('hidden'), 300); 
        });

    //dropdown toggle for view many vehicles
    document.addEventListener('DOMContentLoaded', function () {
        const dropdownToggles = document.querySelectorAll('.toggle-dropdown');

        dropdownToggles.forEach(button => {
            button.addEventListener('click', function () {
                const dropdownId = this.getAttribute('data-dropdown-id');
                const dropdownMenu = document.getElementById(dropdownId);

                if (dropdownMenu.classList.contains('hidden')) {
                    dropdownMenu.classList.remove('hidden');
                } else {
                    dropdownMenu.classList.add('hidden');
                }
            });
        });
    });

    //search bar
    document.getElementById('search-bar').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const rows = document.querySelectorAll('#user-table-body tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let match = false;

            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(query)) {
                    match = true;
                }
            });

            if (match) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
